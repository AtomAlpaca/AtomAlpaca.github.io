<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tufte-css/1.8.0/tufte.min.css">
    <link rel="stylesheet" href="/assets/tufted.css">
    <link rel="stylesheet" href="/assets/custom.css">
  </head>
  <body>
    <header>
      <nav>
        <div><a href="/">Home</a><a href="/blog/">Blog</a><a href="/friends/">Friends</a><a href="/cv/">CV</a></div>
        <div></div>
        <div></div>
      </nav>
    </header>
    <article>
      <section>
        <h3>题意</h3>
        <p><a href="https://www.luogu.com.cn/problem/P5608">link</a></p>
        <p>简述题意：给定由数字和加、乘两种符号组成的表达式，支持区间覆盖数，区间覆盖符号，区间查询表达式值。</p>
        <h3>题解</h3>
        <p>线段树好题。比较考验码力。</p>
        <p>首先考虑节点上要维护哪些信息。</p>
        <p>首先不考虑修改，只考虑快速合并两个区间，我们要记录每个节点表示区间的表达式值 <code>vl</code> ；考虑两个区间交界处的符号是乘号时合并不能简单地把两个答案加起来，我们还要维护区间最右侧的符号 <code>op</code>，左侧、右侧最长的一段连乘段的乘积 <code>lm</code> 和 <code>rm</code>。</p>
        <p>考虑修改符号。首先要设置两个懒标记 <code>at</code>，<code>mt</code> 分别代表覆盖为加、乘。考虑覆盖加后，整个节点的值变为了所有元素的和，我们还要维护区间和 <code>sm</code>；对于乘法，我们同理维护一个区间积 <code>sm</code>。另外，区间覆盖加还会把左、右端最长连乘段变得只剩下一个数，因此还要维护区间最左、右侧值 <code>lv</code> 和 <code>rv</code>。</p>
        <p>修改数字稍微麻烦一些。我们考虑以加号为分界，把每个区间拆成若干连乘段，长度为 <span role="math"><svg class="typst-frame" style="overflow: visible; width: 1.3639999999999999em; height: 0.683em;" viewBox="0 0 15.003999999999998 7.513000000000001" width="15.003999999999998pt" height="7.513000000000001pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:h5="http://www.w3.org/1999/xhtml"><g><g class="typst-text" transform="matrix(1 0 0 -1 0 7.513000000000001)"><use xlink:href="#gB386CDE3DAAA84B0D88334C511FE98AC" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 3.278 7.513000000000001)"><use xlink:href="#g132DD868FE3175B90198E59F48636D7" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 8.404 7.513000000000001)"><use xlink:href="#g1B183B14B2DCB4AB6A3212F8517A6B72" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g></g><defs id="glyph"><symbol id="gB386CDE3DAAA84B0D88334C511FE98AC" overflow="visible"><path d="M 0 0m 1.903 6.952 l -1.3640001 -5.643 c -0.032999992 -0.15400004 -0.054999977 -0.286 -0.054999977 -0.385 c 0 -0.58300006 0.429 -1.0450001 1.0120001 -1.0450001 c 0.53900003 0 0.924 0.572 1.155 1.7160001 c 0 0.09899998 -0.055000067 0.15399992 -0.17600012 0.15399992 c -0.08799982 0 -0.1539998 -0.07700002 -0.1869998 -0.23099995 c -0.22000003 -0.869 -0.47300017 -1.309 -0.7700001 -1.309 c -0.18700004 0 -0.27499998 0.15400001 -0.27499998 0.45099998 c 0 0.16500002 0.021999955 0.34100008 0.065999985 0.5170001 l 1.529 6.292 v 0.04400015 c -0.032999992 0.07700014 -0.09899998 0.12099981 -0.17600012 0.12099981 c -0.352 0 -1.1659999 -0.09899998 -1.298 -0.10999966 c -0.16499996 -0.022000313 -0.24199998 -0.11000013 -0.24199998 -0.2750001 c 0 -0.09899998 0.09899998 -0.15400028 0.30799997 -0.15400028 c 0.18700004 0 0.47300005 0 0.47300005 -0.14299965 Z "/></symbol><symbol id="g132DD868FE3175B90198E59F48636D7" overflow="visible"><path d="M 0 0m 1.364 1.419 c 0 0.26399994 0.055000067 0.627 0.16500008 1.078 h 0.53900003 c 0.7149999 0 1.2649999 0.08800006 1.661 0.25300002 c 0.36299992 0.15400004 0.605 0.37400007 0.72599983 0.6489999 c 0.07700014 0.18700004 0.11000013 0.36300015 0.11000013 0.50600004 c 0 0.6049998 -0.572 0.957 -1.188 0.957 c -0.42900014 0 -0.85800004 -0.11000013 -1.2870002 -0.32999992 c -0.8469999 -0.44000006 -1.5839999 -1.441 -1.5839999 -2.651 c 0 -1.122 0.649 -2.002 1.7379999 -2.002 c 0.58299994 0 1.0999999 0.143 1.5510001 0.41799998 c 0.37400007 0.231 0.6489997 0.462 0.8249998 0.693 c 0.07700014 0.09899998 0.11000013 0.176 0.11000013 0.20899999 c 0 0.12099993 -0.05499983 0.18700004 -0.17600012 0.18700004 c -0.05499983 0 -0.11000013 -0.04400003 -0.17600012 -0.13200009 c -0.36299992 -0.48399997 -0.8139999 -0.79199994 -1.3309999 -0.92399997 c -0.34099984 -0.087999985 -0.59399986 -0.13199998 -0.7809999 -0.13199998 c -0.6270001 0 -0.90200007 0.594 -0.90200007 1.2210001 Z m 2.7610002 2.486 c 0 -0.7260001 -0.704 -1.089 -2.123 -1.089 h -0.3850001 c 0.20899999 0.7260001 0.5170001 1.21 0.93500006 1.441 c 0.32999992 0.1869998 0.605 0.28599977 0.82500005 0.28599977 c 0.3959999 0 0.7479999 -0.24199963 0.7479999 -0.6379998 Z "/></symbol><symbol id="g1B183B14B2DCB4AB6A3212F8517A6B72" overflow="visible"><path d="M 0 0m 5.907 1.507 c -0.25300026 -0.86899996 -0.6160002 -1.309 -1.0669999 -1.309 c -0.14300013 0 -0.22000027 0.11 -0.22000027 0.319 c 0 0.15399998 0.065999985 0.407 0.19799995 0.74799997 c 0.44000006 1.199 0.6600003 1.991 0.6600003 2.3979998 c 0 0.7700002 -0.5170002 1.1990001 -1.2870002 1.1990001 c -0.6489999 0 -1.21 -0.28599977 -1.661 -0.86899996 c -0.08800006 0.48399973 -0.47300005 0.86899996 -1.0339999 0.86899996 c -0.61600006 0 -0.85800004 -0.572 -1.0120001 -1.0669999 c -0.109999985 -0.352 -0.16499999 -0.5610001 -0.16499999 -0.638 c 0 -0.09899998 0.055000007 -0.15400004 0.176 -0.15400004 c 0.055000007 0 0.088 0.010999918 0.12099999 0.032999992 c 0.055000007 0.09899998 0.088 0.17599988 0.09899998 0.25300002 c 0.19800001 0.83599997 0.45100003 1.2539997 0.74799997 1.2539997 c 0.19800007 0 0.29700005 -0.1539998 0.29700005 -0.4619999 c 0 -0.14299989 -0.054999948 -0.43999982 -0.176 -0.8909998 l -0.627 -2.497 c -0.032999992 -0.143 -0.09900004 -0.42900002 -0.09900004 -0.48400003 c 0 -0.22 0.12099999 -0.32999998 0.36299998 -0.32999998 c 0.20899999 0 0.36300004 0.11 0.44000006 0.32999998 c 0.021999955 0.055000007 0.08799994 0.32999998 0.20899999 0.803 l 0.23100007 0.979 l 0.32999992 1.254 c 0.12100005 0.25300002 0.3080001 0.50600004 0.53900003 0.77 c 0.319 0.35200024 0.7149999 0.5279999 1.188 0.5279999 c 0.36299992 0 0.53900003 -0.24199963 0.53900003 -0.7149997 c 0 -0.41799998 -0.23099995 -1.2540002 -0.704 -2.5080001 c -0.07700014 -0.19799995 -0.11000013 -0.36299992 -0.11000013 -0.5059999 c 0 -0.53900003 0.40700006 -0.935 0.93499994 -0.935 c 0.4840002 0 0.86899996 0.275 1.144 0.825 c 0.20900011 0.44000006 0.31900024 0.737 0.31900024 0.88 c 0 0.09899998 -0.055000305 0.15400004 -0.17600012 0.15400004 c -0.032999992 0 -0.19799995 -0.0990001 -0.19799995 -0.23100007 Z "/></symbol></defs></svg></span>，区间改数字就是将区间值改为 <span role="math"><svg class="typst-frame" style="overflow: visible; width: 0.572em; height: 0.683em;" viewBox="0 0 6.292 7.513000000000001" width="6.292pt" height="7.513000000000001pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:h5="http://www.w3.org/1999/xhtml"><g><g class="typst-text" transform="matrix(1 0 0 -1 0 7.513000000000001)"><use xlink:href="#gD8091845B0770766234E6F50AD7A3DEF" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g></g><defs id="glyph"><symbol id="gD8091845B0770766234E6F50AD7A3DEF" overflow="visible"><path d="M 0 0m 5.797 4.103 c 0 0.50600004 -0.4949999 0.7589998 -1.0450001 0.7589998 c -0.47300005 0 -0.8469999 -0.25299978 -1.1329999 -0.7589998 c -0.23099995 0.50600004 -0.61599994 0.7589998 -1.177 0.7589998 c -0.5389999 0 -0.979 -0.25299978 -1.331 -0.74800014 c -0.29699993 -0.4289999 -0.45099998 -0.7479999 -0.45099998 -0.9569998 c 0 -0.09899998 0.055000007 -0.15400004 0.16500002 -0.15400004 c 0.09900004 0 0.16500002 0.055000067 0.18699998 0.15400004 c 0.20899999 0.638 0.671 1.3859997 1.4080001 1.3859997 c 0.36299992 0 0.5389998 -0.23099995 0.5389998 -0.6819997 c 0 -0.23100019 -0.19799995 -1.089 -0.58299994 -2.5630002 c -0.18700004 -0.737 -0.51699996 -1.1 -0.9899999 -1.1 c -0.15400004 0 -0.29700005 0.033000007 -0.41800004 0.088000014 c 0.28599995 0.109999985 0.42899996 0.30799997 0.42899996 0.594 c 0 0.286 -0.143 0.42900002 -0.43999994 0.42900002 c -0.36300004 0 -0.638 -0.30799997 -0.638 -0.671 c 0 -0.50600004 0.51699996 -0.759 1.056 -0.759 c 0.462 0 0.83599997 0.253 1.1329999 0.759 c 0.20900011 -0.50600004 0.605 -0.759 1.177 -0.759 c 0.5279999 0 0.96799994 0.253 1.3200002 0.74799997 c 0.29699993 0.42900002 0.45099974 0.748 0.45099974 0.957 c 0 0.09899998 -0.05499983 0.15400004 -0.16499996 0.15400004 c -0.09899998 0 -0.1539998 -0.055000067 -0.1869998 -0.15400004 c -0.18700027 -0.627 -0.68200016 -1.386 -1.3970001 -1.386 c -0.36300015 0 -0.54999995 0.21999998 -0.54999995 0.671 c 0 0.14299995 0.05499983 0.45099992 0.17599988 0.9459999 l 0.37400007 1.485 c 0.20899987 0.82500005 0.54999995 1.2429998 1.0340002 1.2429998 c 0.1539998 0 0.29699993 -0.032999992 0.41799974 -0.08799982 c -0.29699993 -0.09899998 -0.44000006 -0.29699993 -0.44000006 -0.59399986 c 0 -0.286 0.15400028 -0.42900014 0.4510002 -0.42900014 c 0.35199976 0 0.62699986 0.319 0.62699986 0.67100024 Z "/></symbol></defs></svg></span> 的若干个 <span role="math"><svg class="typst-frame" style="overflow: visible; width: 1.3639999999999999em; height: 0.683em;" viewBox="0 0 15.003999999999998 7.513000000000001" width="15.003999999999998pt" height="7.513000000000001pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:h5="http://www.w3.org/1999/xhtml"><g><g class="typst-text" transform="matrix(1 0 0 -1 0 7.513000000000001)"><use xlink:href="#gB386CDE3DAAA84B0D88334C511FE98AC" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 3.278 7.513000000000001)"><use xlink:href="#g132DD868FE3175B90198E59F48636D7" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 8.404 7.513000000000001)"><use xlink:href="#g1B183B14B2DCB4AB6A3212F8517A6B72" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g></g><defs id="glyph"><symbol id="gB386CDE3DAAA84B0D88334C511FE98AC" overflow="visible"><path d="M 0 0m 1.903 6.952 l -1.3640001 -5.643 c -0.032999992 -0.15400004 -0.054999977 -0.286 -0.054999977 -0.385 c 0 -0.58300006 0.429 -1.0450001 1.0120001 -1.0450001 c 0.53900003 0 0.924 0.572 1.155 1.7160001 c 0 0.09899998 -0.055000067 0.15399992 -0.17600012 0.15399992 c -0.08799982 0 -0.1539998 -0.07700002 -0.1869998 -0.23099995 c -0.22000003 -0.869 -0.47300017 -1.309 -0.7700001 -1.309 c -0.18700004 0 -0.27499998 0.15400001 -0.27499998 0.45099998 c 0 0.16500002 0.021999955 0.34100008 0.065999985 0.5170001 l 1.529 6.292 v 0.04400015 c -0.032999992 0.07700014 -0.09899998 0.12099981 -0.17600012 0.12099981 c -0.352 0 -1.1659999 -0.09899998 -1.298 -0.10999966 c -0.16499996 -0.022000313 -0.24199998 -0.11000013 -0.24199998 -0.2750001 c 0 -0.09899998 0.09899998 -0.15400028 0.30799997 -0.15400028 c 0.18700004 0 0.47300005 0 0.47300005 -0.14299965 Z "/></symbol><symbol id="g132DD868FE3175B90198E59F48636D7" overflow="visible"><path d="M 0 0m 1.364 1.419 c 0 0.26399994 0.055000067 0.627 0.16500008 1.078 h 0.53900003 c 0.7149999 0 1.2649999 0.08800006 1.661 0.25300002 c 0.36299992 0.15400004 0.605 0.37400007 0.72599983 0.6489999 c 0.07700014 0.18700004 0.11000013 0.36300015 0.11000013 0.50600004 c 0 0.6049998 -0.572 0.957 -1.188 0.957 c -0.42900014 0 -0.85800004 -0.11000013 -1.2870002 -0.32999992 c -0.8469999 -0.44000006 -1.5839999 -1.441 -1.5839999 -2.651 c 0 -1.122 0.649 -2.002 1.7379999 -2.002 c 0.58299994 0 1.0999999 0.143 1.5510001 0.41799998 c 0.37400007 0.231 0.6489997 0.462 0.8249998 0.693 c 0.07700014 0.09899998 0.11000013 0.176 0.11000013 0.20899999 c 0 0.12099993 -0.05499983 0.18700004 -0.17600012 0.18700004 c -0.05499983 0 -0.11000013 -0.04400003 -0.17600012 -0.13200009 c -0.36299992 -0.48399997 -0.8139999 -0.79199994 -1.3309999 -0.92399997 c -0.34099984 -0.087999985 -0.59399986 -0.13199998 -0.7809999 -0.13199998 c -0.6270001 0 -0.90200007 0.594 -0.90200007 1.2210001 Z m 2.7610002 2.486 c 0 -0.7260001 -0.704 -1.089 -2.123 -1.089 h -0.3850001 c 0.20899999 0.7260001 0.5170001 1.21 0.93500006 1.441 c 0.32999992 0.1869998 0.605 0.28599977 0.82500005 0.28599977 c 0.3959999 0 0.7479999 -0.24199963 0.7479999 -0.6379998 Z "/></symbol><symbol id="g1B183B14B2DCB4AB6A3212F8517A6B72" overflow="visible"><path d="M 0 0m 5.907 1.507 c -0.25300026 -0.86899996 -0.6160002 -1.309 -1.0669999 -1.309 c -0.14300013 0 -0.22000027 0.11 -0.22000027 0.319 c 0 0.15399998 0.065999985 0.407 0.19799995 0.74799997 c 0.44000006 1.199 0.6600003 1.991 0.6600003 2.3979998 c 0 0.7700002 -0.5170002 1.1990001 -1.2870002 1.1990001 c -0.6489999 0 -1.21 -0.28599977 -1.661 -0.86899996 c -0.08800006 0.48399973 -0.47300005 0.86899996 -1.0339999 0.86899996 c -0.61600006 0 -0.85800004 -0.572 -1.0120001 -1.0669999 c -0.109999985 -0.352 -0.16499999 -0.5610001 -0.16499999 -0.638 c 0 -0.09899998 0.055000007 -0.15400004 0.176 -0.15400004 c 0.055000007 0 0.088 0.010999918 0.12099999 0.032999992 c 0.055000007 0.09899998 0.088 0.17599988 0.09899998 0.25300002 c 0.19800001 0.83599997 0.45100003 1.2539997 0.74799997 1.2539997 c 0.19800007 0 0.29700005 -0.1539998 0.29700005 -0.4619999 c 0 -0.14299989 -0.054999948 -0.43999982 -0.176 -0.8909998 l -0.627 -2.497 c -0.032999992 -0.143 -0.09900004 -0.42900002 -0.09900004 -0.48400003 c 0 -0.22 0.12099999 -0.32999998 0.36299998 -0.32999998 c 0.20899999 0 0.36300004 0.11 0.44000006 0.32999998 c 0.021999955 0.055000007 0.08799994 0.32999998 0.20899999 0.803 l 0.23100007 0.979 l 0.32999992 1.254 c 0.12100005 0.25300002 0.3080001 0.50600004 0.53900003 0.77 c 0.319 0.35200024 0.7149999 0.5279999 1.188 0.5279999 c 0.36299992 0 0.53900003 -0.24199963 0.53900003 -0.7149997 c 0 -0.41799998 -0.23099995 -1.2540002 -0.704 -2.5080001 c -0.07700014 -0.19799995 -0.11000013 -0.36299992 -0.11000013 -0.5059999 c 0 -0.53900003 0.40700006 -0.935 0.93499994 -0.935 c 0.4840002 0 0.86899996 0.275 1.144 0.825 c 0.20900011 0.44000006 0.31900024 0.737 0.31900024 0.88 c 0 0.09899998 -0.055000305 0.15400004 -0.17600012 0.15400004 c -0.032999992 0 -0.19799995 -0.0990001 -0.19799995 -0.23100007 Z "/></symbol></defs></svg></span> 次幂的和。因此我们考虑开一个 <code>vector</code> 存下每个区间内的所有区间连乘段的长度。为了方便区间覆盖加，我们还可以维护一个区间长度 <code>ln</code>，不过这并不是必要的。</p>
        <p>这时候发现，合并的两个区间的分界处是乘号时，对合并成的新区间内的连乘段也有影响，于是考虑再维护一个最左、右端连乘段长度 <code>lc</code> 和 <code>rc</code>。</p>
        <p>好！现在弄明白了维护哪些信息，具体的维护方法也呼之欲出了！</p>
        <p>每次将一个节点覆盖加号，将 <code>op</code> 改为加，<code>vl</code> 改为 <code>sm</code>， <code>lc</code>、<code>rc</code> 变为 <code>1</code>，<code>lm</code>、<code>rm</code> 分别改为 <code>lv</code>、<code>rv</code>，然后把区间长度 <span role="math"><svg class="typst-frame" style="overflow: visible; width: 1.3639999999999999em; height: 0.683em;" viewBox="0 0 15.003999999999998 7.513000000000001" width="15.003999999999998pt" height="7.513000000000001pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:h5="http://www.w3.org/1999/xhtml"><g><g class="typst-text" transform="matrix(1 0 0 -1 0 7.513000000000001)"><use xlink:href="#gB386CDE3DAAA84B0D88334C511FE98AC" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 3.278 7.513000000000001)"><use xlink:href="#g132DD868FE3175B90198E59F48636D7" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 8.404 7.513000000000001)"><use xlink:href="#g1B183B14B2DCB4AB6A3212F8517A6B72" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g></g><defs id="glyph"><symbol id="gB386CDE3DAAA84B0D88334C511FE98AC" overflow="visible"><path d="M 0 0m 1.903 6.952 l -1.3640001 -5.643 c -0.032999992 -0.15400004 -0.054999977 -0.286 -0.054999977 -0.385 c 0 -0.58300006 0.429 -1.0450001 1.0120001 -1.0450001 c 0.53900003 0 0.924 0.572 1.155 1.7160001 c 0 0.09899998 -0.055000067 0.15399992 -0.17600012 0.15399992 c -0.08799982 0 -0.1539998 -0.07700002 -0.1869998 -0.23099995 c -0.22000003 -0.869 -0.47300017 -1.309 -0.7700001 -1.309 c -0.18700004 0 -0.27499998 0.15400001 -0.27499998 0.45099998 c 0 0.16500002 0.021999955 0.34100008 0.065999985 0.5170001 l 1.529 6.292 v 0.04400015 c -0.032999992 0.07700014 -0.09899998 0.12099981 -0.17600012 0.12099981 c -0.352 0 -1.1659999 -0.09899998 -1.298 -0.10999966 c -0.16499996 -0.022000313 -0.24199998 -0.11000013 -0.24199998 -0.2750001 c 0 -0.09899998 0.09899998 -0.15400028 0.30799997 -0.15400028 c 0.18700004 0 0.47300005 0 0.47300005 -0.14299965 Z "/></symbol><symbol id="g132DD868FE3175B90198E59F48636D7" overflow="visible"><path d="M 0 0m 1.364 1.419 c 0 0.26399994 0.055000067 0.627 0.16500008 1.078 h 0.53900003 c 0.7149999 0 1.2649999 0.08800006 1.661 0.25300002 c 0.36299992 0.15400004 0.605 0.37400007 0.72599983 0.6489999 c 0.07700014 0.18700004 0.11000013 0.36300015 0.11000013 0.50600004 c 0 0.6049998 -0.572 0.957 -1.188 0.957 c -0.42900014 0 -0.85800004 -0.11000013 -1.2870002 -0.32999992 c -0.8469999 -0.44000006 -1.5839999 -1.441 -1.5839999 -2.651 c 0 -1.122 0.649 -2.002 1.7379999 -2.002 c 0.58299994 0 1.0999999 0.143 1.5510001 0.41799998 c 0.37400007 0.231 0.6489997 0.462 0.8249998 0.693 c 0.07700014 0.09899998 0.11000013 0.176 0.11000013 0.20899999 c 0 0.12099993 -0.05499983 0.18700004 -0.17600012 0.18700004 c -0.05499983 0 -0.11000013 -0.04400003 -0.17600012 -0.13200009 c -0.36299992 -0.48399997 -0.8139999 -0.79199994 -1.3309999 -0.92399997 c -0.34099984 -0.087999985 -0.59399986 -0.13199998 -0.7809999 -0.13199998 c -0.6270001 0 -0.90200007 0.594 -0.90200007 1.2210001 Z m 2.7610002 2.486 c 0 -0.7260001 -0.704 -1.089 -2.123 -1.089 h -0.3850001 c 0.20899999 0.7260001 0.5170001 1.21 0.93500006 1.441 c 0.32999992 0.1869998 0.605 0.28599977 0.82500005 0.28599977 c 0.3959999 0 0.7479999 -0.24199963 0.7479999 -0.6379998 Z "/></symbol><symbol id="g1B183B14B2DCB4AB6A3212F8517A6B72" overflow="visible"><path d="M 0 0m 5.907 1.507 c -0.25300026 -0.86899996 -0.6160002 -1.309 -1.0669999 -1.309 c -0.14300013 0 -0.22000027 0.11 -0.22000027 0.319 c 0 0.15399998 0.065999985 0.407 0.19799995 0.74799997 c 0.44000006 1.199 0.6600003 1.991 0.6600003 2.3979998 c 0 0.7700002 -0.5170002 1.1990001 -1.2870002 1.1990001 c -0.6489999 0 -1.21 -0.28599977 -1.661 -0.86899996 c -0.08800006 0.48399973 -0.47300005 0.86899996 -1.0339999 0.86899996 c -0.61600006 0 -0.85800004 -0.572 -1.0120001 -1.0669999 c -0.109999985 -0.352 -0.16499999 -0.5610001 -0.16499999 -0.638 c 0 -0.09899998 0.055000007 -0.15400004 0.176 -0.15400004 c 0.055000007 0 0.088 0.010999918 0.12099999 0.032999992 c 0.055000007 0.09899998 0.088 0.17599988 0.09899998 0.25300002 c 0.19800001 0.83599997 0.45100003 1.2539997 0.74799997 1.2539997 c 0.19800007 0 0.29700005 -0.1539998 0.29700005 -0.4619999 c 0 -0.14299989 -0.054999948 -0.43999982 -0.176 -0.8909998 l -0.627 -2.497 c -0.032999992 -0.143 -0.09900004 -0.42900002 -0.09900004 -0.48400003 c 0 -0.22 0.12099999 -0.32999998 0.36299998 -0.32999998 c 0.20899999 0 0.36300004 0.11 0.44000006 0.32999998 c 0.021999955 0.055000007 0.08799994 0.32999998 0.20899999 0.803 l 0.23100007 0.979 l 0.32999992 1.254 c 0.12100005 0.25300002 0.3080001 0.50600004 0.53900003 0.77 c 0.319 0.35200024 0.7149999 0.5279999 1.188 0.5279999 c 0.36299992 0 0.53900003 -0.24199963 0.53900003 -0.7149997 c 0 -0.41799998 -0.23099995 -1.2540002 -0.704 -2.5080001 c -0.07700014 -0.19799995 -0.11000013 -0.36299992 -0.11000013 -0.5059999 c 0 -0.53900003 0.40700006 -0.935 0.93499994 -0.935 c 0.4840002 0 0.86899996 0.275 1.144 0.825 c 0.20900011 0.44000006 0.31900024 0.737 0.31900024 0.88 c 0 0.09899998 -0.055000305 0.15400004 -0.17600012 0.15400004 c -0.032999992 0 -0.19799995 -0.0990001 -0.19799995 -0.23100007 Z "/></symbol></defs></svg></span> 个 <code>1</code> 扔进 <code>vector</code> 里即可。</p>
        <p>区间覆盖乘号、数字和区间覆盖加号的原理基本相同，这里不加赘述。</p>
        <p>然后是区间合并。当分界处符号（也就是左区间最右侧符号 <code>op</code>）为加的时候，显然新区间的值就是两个区间的值加起来；否则应当分别去掉两个区间的右、左极长连乘段，在把连乘段的乘积加上；其次将两个区间的 <code>vector</code> 合并起来，极长左乘右乘段跨区间时类似区间值处理即可。</p>
        <p>但是这样写，你会发现会 T 掉一些点，我们考虑优化。</p>
        <p>首先我们发现查询答案的时候很多信息其实是不需要维护的，比如区间内的 <code>vector</code>、区间和、区间积，最左、右值等等。于是我们可以另写一个区间合并来省下维护这些信息的时间。</p>
        <p>然后我们发现区间内长度不同的数量稍微有些多，区间覆盖数字时挨个做快速幂还是不够快，于是我们考虑把这些段排序，然后从小到大扫，一路乘过去。要让区间有序，只需要在合并两个区间的时候把两个 <code>vector</code> 并归一下即可。</p>
        <p>而且 <code>vector</code> 的速度也太慢了，但是我们区间内开桶又开不下，于是可以考虑根号分治，区间维护一个大小为 <span role="math"><svg class="typst-frame" style="overflow: visible; width: 2.197em; height: 0.683em;" viewBox="0 0 24.166999999999998 7.513000000000001" width="24.166999999999998pt" height="7.513000000000001pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:h5="http://www.w3.org/1999/xhtml"><g><g class="typst-text" transform="matrix(1 0 0 -1 0 -1.8424999999999996)"><use xlink:href="#gFACE7C135B391EE3C855CFEEC51DBEF2" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><path class="typst-shape" fill="none" stroke="#000000" stroke-width="0.528" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="4" transform="matrix(1 0 0 1 9.163 -2.0184999999999986)" d="M 0 0h 15.004 "/><g class="typst-text" transform="matrix(1 0 0 -1 9.163 7.513000000000001)"><use xlink:href="#gB386CDE3DAAA84B0D88334C511FE98AC" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 12.441 7.513000000000001)"><use xlink:href="#g132DD868FE3175B90198E59F48636D7" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 17.567 7.513000000000001)"><use xlink:href="#g1B183B14B2DCB4AB6A3212F8517A6B72" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g></g><defs id="glyph"><symbol id="gFACE7C135B391EE3C855CFEEC51DBEF2" overflow="visible"><path d="M 0 0m 9.317 -0.022 c 0.043999672 0.099 0.065999985 0.165 0.065999985 0.198 c 0 0.176 -0.0880003 0.264 -0.2640009 0.264 c -0.09899998 0 -0.17599964 -0.044 -0.21999931 -0.143 c -1.5730004 -3.146 -2.354 -4.73 -2.354 -4.752 v -0.011000156 c 0 -0.076999664 -0.74800014 -1.6719999 -2.255 -4.8069997 l -1.9029999 4.2019997 c -0.055000067 0.12100029 -0.11000013 0.17600012 -0.17600012 0.17600012 c -0.032999992 0 -0.09899998 -0.032999992 -0.18700004 -0.09899998 l -1.078 -0.8140001 c -0.09899998 -0.076999664 -0.143 -0.13199997 -0.143 -0.1869998 c 0 -0.11000013 0.055000007 -0.16499996 0.15400004 -0.16499996 c 0.032999992 0 0.08799994 0.032999992 0.176 0.09899998 l 0.528 0.38499975 l 2.134 -4.697 c 0.05499983 -0.120999336 0.13199997 -0.18699932 0.2420001 -0.18699932 c 0.13199997 0 0.21999979 0.05499935 0.27499962 0.15399933 Z "/></symbol><symbol id="gB386CDE3DAAA84B0D88334C511FE98AC" overflow="visible"><path d="M 0 0m 1.903 6.952 l -1.3640001 -5.643 c -0.032999992 -0.15400004 -0.054999977 -0.286 -0.054999977 -0.385 c 0 -0.58300006 0.429 -1.0450001 1.0120001 -1.0450001 c 0.53900003 0 0.924 0.572 1.155 1.7160001 c 0 0.09899998 -0.055000067 0.15399992 -0.17600012 0.15399992 c -0.08799982 0 -0.1539998 -0.07700002 -0.1869998 -0.23099995 c -0.22000003 -0.869 -0.47300017 -1.309 -0.7700001 -1.309 c -0.18700004 0 -0.27499998 0.15400001 -0.27499998 0.45099998 c 0 0.16500002 0.021999955 0.34100008 0.065999985 0.5170001 l 1.529 6.292 v 0.04400015 c -0.032999992 0.07700014 -0.09899998 0.12099981 -0.17600012 0.12099981 c -0.352 0 -1.1659999 -0.09899998 -1.298 -0.10999966 c -0.16499996 -0.022000313 -0.24199998 -0.11000013 -0.24199998 -0.2750001 c 0 -0.09899998 0.09899998 -0.15400028 0.30799997 -0.15400028 c 0.18700004 0 0.47300005 0 0.47300005 -0.14299965 Z "/></symbol><symbol id="g132DD868FE3175B90198E59F48636D7" overflow="visible"><path d="M 0 0m 1.364 1.419 c 0 0.26399994 0.055000067 0.627 0.16500008 1.078 h 0.53900003 c 0.7149999 0 1.2649999 0.08800006 1.661 0.25300002 c 0.36299992 0.15400004 0.605 0.37400007 0.72599983 0.6489999 c 0.07700014 0.18700004 0.11000013 0.36300015 0.11000013 0.50600004 c 0 0.6049998 -0.572 0.957 -1.188 0.957 c -0.42900014 0 -0.85800004 -0.11000013 -1.2870002 -0.32999992 c -0.8469999 -0.44000006 -1.5839999 -1.441 -1.5839999 -2.651 c 0 -1.122 0.649 -2.002 1.7379999 -2.002 c 0.58299994 0 1.0999999 0.143 1.5510001 0.41799998 c 0.37400007 0.231 0.6489997 0.462 0.8249998 0.693 c 0.07700014 0.09899998 0.11000013 0.176 0.11000013 0.20899999 c 0 0.12099993 -0.05499983 0.18700004 -0.17600012 0.18700004 c -0.05499983 0 -0.11000013 -0.04400003 -0.17600012 -0.13200009 c -0.36299992 -0.48399997 -0.8139999 -0.79199994 -1.3309999 -0.92399997 c -0.34099984 -0.087999985 -0.59399986 -0.13199998 -0.7809999 -0.13199998 c -0.6270001 0 -0.90200007 0.594 -0.90200007 1.2210001 Z m 2.7610002 2.486 c 0 -0.7260001 -0.704 -1.089 -2.123 -1.089 h -0.3850001 c 0.20899999 0.7260001 0.5170001 1.21 0.93500006 1.441 c 0.32999992 0.1869998 0.605 0.28599977 0.82500005 0.28599977 c 0.3959999 0 0.7479999 -0.24199963 0.7479999 -0.6379998 Z "/></symbol><symbol id="g1B183B14B2DCB4AB6A3212F8517A6B72" overflow="visible"><path d="M 0 0m 5.907 1.507 c -0.25300026 -0.86899996 -0.6160002 -1.309 -1.0669999 -1.309 c -0.14300013 0 -0.22000027 0.11 -0.22000027 0.319 c 0 0.15399998 0.065999985 0.407 0.19799995 0.74799997 c 0.44000006 1.199 0.6600003 1.991 0.6600003 2.3979998 c 0 0.7700002 -0.5170002 1.1990001 -1.2870002 1.1990001 c -0.6489999 0 -1.21 -0.28599977 -1.661 -0.86899996 c -0.08800006 0.48399973 -0.47300005 0.86899996 -1.0339999 0.86899996 c -0.61600006 0 -0.85800004 -0.572 -1.0120001 -1.0669999 c -0.109999985 -0.352 -0.16499999 -0.5610001 -0.16499999 -0.638 c 0 -0.09899998 0.055000007 -0.15400004 0.176 -0.15400004 c 0.055000007 0 0.088 0.010999918 0.12099999 0.032999992 c 0.055000007 0.09899998 0.088 0.17599988 0.09899998 0.25300002 c 0.19800001 0.83599997 0.45100003 1.2539997 0.74799997 1.2539997 c 0.19800007 0 0.29700005 -0.1539998 0.29700005 -0.4619999 c 0 -0.14299989 -0.054999948 -0.43999982 -0.176 -0.8909998 l -0.627 -2.497 c -0.032999992 -0.143 -0.09900004 -0.42900002 -0.09900004 -0.48400003 c 0 -0.22 0.12099999 -0.32999998 0.36299998 -0.32999998 c 0.20899999 0 0.36300004 0.11 0.44000006 0.32999998 c 0.021999955 0.055000007 0.08799994 0.32999998 0.20899999 0.803 l 0.23100007 0.979 l 0.32999992 1.254 c 0.12100005 0.25300002 0.3080001 0.50600004 0.53900003 0.77 c 0.319 0.35200024 0.7149999 0.5279999 1.188 0.5279999 c 0.36299992 0 0.53900003 -0.24199963 0.53900003 -0.7149997 c 0 -0.41799998 -0.23099995 -1.2540002 -0.704 -2.5080001 c -0.07700014 -0.19799995 -0.11000013 -0.36299992 -0.11000013 -0.5059999 c 0 -0.53900003 0.40700006 -0.935 0.93499994 -0.935 c 0.4840002 0 0.86899996 0.275 1.144 0.825 c 0.20900011 0.44000006 0.31900024 0.737 0.31900024 0.88 c 0 0.09899998 -0.055000305 0.15400004 -0.17600012 0.15400004 c -0.032999992 0 -0.19799995 -0.0990001 -0.19799995 -0.23100007 Z "/></symbol></defs></svg></span> 长度的桶，把 <code>vector</code> 里小于 <span role="math"><svg class="typst-frame" style="overflow: visible; width: 2.197em; height: 0.683em;" viewBox="0 0 24.166999999999998 7.513000000000001" width="24.166999999999998pt" height="7.513000000000001pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:h5="http://www.w3.org/1999/xhtml"><g><g class="typst-text" transform="matrix(1 0 0 -1 0 -1.8424999999999996)"><use xlink:href="#gFACE7C135B391EE3C855CFEEC51DBEF2" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><path class="typst-shape" fill="none" stroke="#000000" stroke-width="0.528" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="4" transform="matrix(1 0 0 1 9.163 -2.0184999999999986)" d="M 0 0h 15.004 "/><g class="typst-text" transform="matrix(1 0 0 -1 9.163 7.513000000000001)"><use xlink:href="#gB386CDE3DAAA84B0D88334C511FE98AC" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 12.441 7.513000000000001)"><use xlink:href="#g132DD868FE3175B90198E59F48636D7" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 17.567 7.513000000000001)"><use xlink:href="#g1B183B14B2DCB4AB6A3212F8517A6B72" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g></g><defs id="glyph"><symbol id="gFACE7C135B391EE3C855CFEEC51DBEF2" overflow="visible"><path d="M 0 0m 9.317 -0.022 c 0.043999672 0.099 0.065999985 0.165 0.065999985 0.198 c 0 0.176 -0.0880003 0.264 -0.2640009 0.264 c -0.09899998 0 -0.17599964 -0.044 -0.21999931 -0.143 c -1.5730004 -3.146 -2.354 -4.73 -2.354 -4.752 v -0.011000156 c 0 -0.076999664 -0.74800014 -1.6719999 -2.255 -4.8069997 l -1.9029999 4.2019997 c -0.055000067 0.12100029 -0.11000013 0.17600012 -0.17600012 0.17600012 c -0.032999992 0 -0.09899998 -0.032999992 -0.18700004 -0.09899998 l -1.078 -0.8140001 c -0.09899998 -0.076999664 -0.143 -0.13199997 -0.143 -0.1869998 c 0 -0.11000013 0.055000007 -0.16499996 0.15400004 -0.16499996 c 0.032999992 0 0.08799994 0.032999992 0.176 0.09899998 l 0.528 0.38499975 l 2.134 -4.697 c 0.05499983 -0.120999336 0.13199997 -0.18699932 0.2420001 -0.18699932 c 0.13199997 0 0.21999979 0.05499935 0.27499962 0.15399933 Z "/></symbol><symbol id="gB386CDE3DAAA84B0D88334C511FE98AC" overflow="visible"><path d="M 0 0m 1.903 6.952 l -1.3640001 -5.643 c -0.032999992 -0.15400004 -0.054999977 -0.286 -0.054999977 -0.385 c 0 -0.58300006 0.429 -1.0450001 1.0120001 -1.0450001 c 0.53900003 0 0.924 0.572 1.155 1.7160001 c 0 0.09899998 -0.055000067 0.15399992 -0.17600012 0.15399992 c -0.08799982 0 -0.1539998 -0.07700002 -0.1869998 -0.23099995 c -0.22000003 -0.869 -0.47300017 -1.309 -0.7700001 -1.309 c -0.18700004 0 -0.27499998 0.15400001 -0.27499998 0.45099998 c 0 0.16500002 0.021999955 0.34100008 0.065999985 0.5170001 l 1.529 6.292 v 0.04400015 c -0.032999992 0.07700014 -0.09899998 0.12099981 -0.17600012 0.12099981 c -0.352 0 -1.1659999 -0.09899998 -1.298 -0.10999966 c -0.16499996 -0.022000313 -0.24199998 -0.11000013 -0.24199998 -0.2750001 c 0 -0.09899998 0.09899998 -0.15400028 0.30799997 -0.15400028 c 0.18700004 0 0.47300005 0 0.47300005 -0.14299965 Z "/></symbol><symbol id="g132DD868FE3175B90198E59F48636D7" overflow="visible"><path d="M 0 0m 1.364 1.419 c 0 0.26399994 0.055000067 0.627 0.16500008 1.078 h 0.53900003 c 0.7149999 0 1.2649999 0.08800006 1.661 0.25300002 c 0.36299992 0.15400004 0.605 0.37400007 0.72599983 0.6489999 c 0.07700014 0.18700004 0.11000013 0.36300015 0.11000013 0.50600004 c 0 0.6049998 -0.572 0.957 -1.188 0.957 c -0.42900014 0 -0.85800004 -0.11000013 -1.2870002 -0.32999992 c -0.8469999 -0.44000006 -1.5839999 -1.441 -1.5839999 -2.651 c 0 -1.122 0.649 -2.002 1.7379999 -2.002 c 0.58299994 0 1.0999999 0.143 1.5510001 0.41799998 c 0.37400007 0.231 0.6489997 0.462 0.8249998 0.693 c 0.07700014 0.09899998 0.11000013 0.176 0.11000013 0.20899999 c 0 0.12099993 -0.05499983 0.18700004 -0.17600012 0.18700004 c -0.05499983 0 -0.11000013 -0.04400003 -0.17600012 -0.13200009 c -0.36299992 -0.48399997 -0.8139999 -0.79199994 -1.3309999 -0.92399997 c -0.34099984 -0.087999985 -0.59399986 -0.13199998 -0.7809999 -0.13199998 c -0.6270001 0 -0.90200007 0.594 -0.90200007 1.2210001 Z m 2.7610002 2.486 c 0 -0.7260001 -0.704 -1.089 -2.123 -1.089 h -0.3850001 c 0.20899999 0.7260001 0.5170001 1.21 0.93500006 1.441 c 0.32999992 0.1869998 0.605 0.28599977 0.82500005 0.28599977 c 0.3959999 0 0.7479999 -0.24199963 0.7479999 -0.6379998 Z "/></symbol><symbol id="g1B183B14B2DCB4AB6A3212F8517A6B72" overflow="visible"><path d="M 0 0m 5.907 1.507 c -0.25300026 -0.86899996 -0.6160002 -1.309 -1.0669999 -1.309 c -0.14300013 0 -0.22000027 0.11 -0.22000027 0.319 c 0 0.15399998 0.065999985 0.407 0.19799995 0.74799997 c 0.44000006 1.199 0.6600003 1.991 0.6600003 2.3979998 c 0 0.7700002 -0.5170002 1.1990001 -1.2870002 1.1990001 c -0.6489999 0 -1.21 -0.28599977 -1.661 -0.86899996 c -0.08800006 0.48399973 -0.47300005 0.86899996 -1.0339999 0.86899996 c -0.61600006 0 -0.85800004 -0.572 -1.0120001 -1.0669999 c -0.109999985 -0.352 -0.16499999 -0.5610001 -0.16499999 -0.638 c 0 -0.09899998 0.055000007 -0.15400004 0.176 -0.15400004 c 0.055000007 0 0.088 0.010999918 0.12099999 0.032999992 c 0.055000007 0.09899998 0.088 0.17599988 0.09899998 0.25300002 c 0.19800001 0.83599997 0.45100003 1.2539997 0.74799997 1.2539997 c 0.19800007 0 0.29700005 -0.1539998 0.29700005 -0.4619999 c 0 -0.14299989 -0.054999948 -0.43999982 -0.176 -0.8909998 l -0.627 -2.497 c -0.032999992 -0.143 -0.09900004 -0.42900002 -0.09900004 -0.48400003 c 0 -0.22 0.12099999 -0.32999998 0.36299998 -0.32999998 c 0.20899999 0 0.36300004 0.11 0.44000006 0.32999998 c 0.021999955 0.055000007 0.08799994 0.32999998 0.20899999 0.803 l 0.23100007 0.979 l 0.32999992 1.254 c 0.12100005 0.25300002 0.3080001 0.50600004 0.53900003 0.77 c 0.319 0.35200024 0.7149999 0.5279999 1.188 0.5279999 c 0.36299992 0 0.53900003 -0.24199963 0.53900003 -0.7149997 c 0 -0.41799998 -0.23099995 -1.2540002 -0.704 -2.5080001 c -0.07700014 -0.19799995 -0.11000013 -0.36299992 -0.11000013 -0.5059999 c 0 -0.53900003 0.40700006 -0.935 0.93499994 -0.935 c 0.4840002 0 0.86899996 0.275 1.144 0.825 c 0.20900011 0.44000006 0.31900024 0.737 0.31900024 0.88 c 0 0.09899998 -0.055000305 0.15400004 -0.17600012 0.15400004 c -0.032999992 0 -0.19799995 -0.0990001 -0.19799995 -0.23100007 Z "/></symbol></defs></svg></span> 的数扔到这个桶里，剩下的数不会超过 <span role="math"><svg class="typst-frame" style="overflow: visible; width: 2.197em; height: 0.683em;" viewBox="0 0 24.166999999999998 7.513000000000001" width="24.166999999999998pt" height="7.513000000000001pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:h5="http://www.w3.org/1999/xhtml"><g><g class="typst-text" transform="matrix(1 0 0 -1 0 -1.8424999999999996)"><use xlink:href="#gFACE7C135B391EE3C855CFEEC51DBEF2" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><path class="typst-shape" fill="none" stroke="#000000" stroke-width="0.528" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="4" transform="matrix(1 0 0 1 9.163 -2.0184999999999986)" d="M 0 0h 15.004 "/><g class="typst-text" transform="matrix(1 0 0 -1 9.163 7.513000000000001)"><use xlink:href="#gB386CDE3DAAA84B0D88334C511FE98AC" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 12.441 7.513000000000001)"><use xlink:href="#g132DD868FE3175B90198E59F48636D7" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g><g class="typst-text" transform="matrix(1 0 0 -1 17.567 7.513000000000001)"><use xlink:href="#g1B183B14B2DCB4AB6A3212F8517A6B72" x="0" y="0" fill="#000000" fill-rule="nonzero"/></g></g><defs id="glyph"><symbol id="gFACE7C135B391EE3C855CFEEC51DBEF2" overflow="visible"><path d="M 0 0m 9.317 -0.022 c 0.043999672 0.099 0.065999985 0.165 0.065999985 0.198 c 0 0.176 -0.0880003 0.264 -0.2640009 0.264 c -0.09899998 0 -0.17599964 -0.044 -0.21999931 -0.143 c -1.5730004 -3.146 -2.354 -4.73 -2.354 -4.752 v -0.011000156 c 0 -0.076999664 -0.74800014 -1.6719999 -2.255 -4.8069997 l -1.9029999 4.2019997 c -0.055000067 0.12100029 -0.11000013 0.17600012 -0.17600012 0.17600012 c -0.032999992 0 -0.09899998 -0.032999992 -0.18700004 -0.09899998 l -1.078 -0.8140001 c -0.09899998 -0.076999664 -0.143 -0.13199997 -0.143 -0.1869998 c 0 -0.11000013 0.055000007 -0.16499996 0.15400004 -0.16499996 c 0.032999992 0 0.08799994 0.032999992 0.176 0.09899998 l 0.528 0.38499975 l 2.134 -4.697 c 0.05499983 -0.120999336 0.13199997 -0.18699932 0.2420001 -0.18699932 c 0.13199997 0 0.21999979 0.05499935 0.27499962 0.15399933 Z "/></symbol><symbol id="gB386CDE3DAAA84B0D88334C511FE98AC" overflow="visible"><path d="M 0 0m 1.903 6.952 l -1.3640001 -5.643 c -0.032999992 -0.15400004 -0.054999977 -0.286 -0.054999977 -0.385 c 0 -0.58300006 0.429 -1.0450001 1.0120001 -1.0450001 c 0.53900003 0 0.924 0.572 1.155 1.7160001 c 0 0.09899998 -0.055000067 0.15399992 -0.17600012 0.15399992 c -0.08799982 0 -0.1539998 -0.07700002 -0.1869998 -0.23099995 c -0.22000003 -0.869 -0.47300017 -1.309 -0.7700001 -1.309 c -0.18700004 0 -0.27499998 0.15400001 -0.27499998 0.45099998 c 0 0.16500002 0.021999955 0.34100008 0.065999985 0.5170001 l 1.529 6.292 v 0.04400015 c -0.032999992 0.07700014 -0.09899998 0.12099981 -0.17600012 0.12099981 c -0.352 0 -1.1659999 -0.09899998 -1.298 -0.10999966 c -0.16499996 -0.022000313 -0.24199998 -0.11000013 -0.24199998 -0.2750001 c 0 -0.09899998 0.09899998 -0.15400028 0.30799997 -0.15400028 c 0.18700004 0 0.47300005 0 0.47300005 -0.14299965 Z "/></symbol><symbol id="g132DD868FE3175B90198E59F48636D7" overflow="visible"><path d="M 0 0m 1.364 1.419 c 0 0.26399994 0.055000067 0.627 0.16500008 1.078 h 0.53900003 c 0.7149999 0 1.2649999 0.08800006 1.661 0.25300002 c 0.36299992 0.15400004 0.605 0.37400007 0.72599983 0.6489999 c 0.07700014 0.18700004 0.11000013 0.36300015 0.11000013 0.50600004 c 0 0.6049998 -0.572 0.957 -1.188 0.957 c -0.42900014 0 -0.85800004 -0.11000013 -1.2870002 -0.32999992 c -0.8469999 -0.44000006 -1.5839999 -1.441 -1.5839999 -2.651 c 0 -1.122 0.649 -2.002 1.7379999 -2.002 c 0.58299994 0 1.0999999 0.143 1.5510001 0.41799998 c 0.37400007 0.231 0.6489997 0.462 0.8249998 0.693 c 0.07700014 0.09899998 0.11000013 0.176 0.11000013 0.20899999 c 0 0.12099993 -0.05499983 0.18700004 -0.17600012 0.18700004 c -0.05499983 0 -0.11000013 -0.04400003 -0.17600012 -0.13200009 c -0.36299992 -0.48399997 -0.8139999 -0.79199994 -1.3309999 -0.92399997 c -0.34099984 -0.087999985 -0.59399986 -0.13199998 -0.7809999 -0.13199998 c -0.6270001 0 -0.90200007 0.594 -0.90200007 1.2210001 Z m 2.7610002 2.486 c 0 -0.7260001 -0.704 -1.089 -2.123 -1.089 h -0.3850001 c 0.20899999 0.7260001 0.5170001 1.21 0.93500006 1.441 c 0.32999992 0.1869998 0.605 0.28599977 0.82500005 0.28599977 c 0.3959999 0 0.7479999 -0.24199963 0.7479999 -0.6379998 Z "/></symbol><symbol id="g1B183B14B2DCB4AB6A3212F8517A6B72" overflow="visible"><path d="M 0 0m 5.907 1.507 c -0.25300026 -0.86899996 -0.6160002 -1.309 -1.0669999 -1.309 c -0.14300013 0 -0.22000027 0.11 -0.22000027 0.319 c 0 0.15399998 0.065999985 0.407 0.19799995 0.74799997 c 0.44000006 1.199 0.6600003 1.991 0.6600003 2.3979998 c 0 0.7700002 -0.5170002 1.1990001 -1.2870002 1.1990001 c -0.6489999 0 -1.21 -0.28599977 -1.661 -0.86899996 c -0.08800006 0.48399973 -0.47300005 0.86899996 -1.0339999 0.86899996 c -0.61600006 0 -0.85800004 -0.572 -1.0120001 -1.0669999 c -0.109999985 -0.352 -0.16499999 -0.5610001 -0.16499999 -0.638 c 0 -0.09899998 0.055000007 -0.15400004 0.176 -0.15400004 c 0.055000007 0 0.088 0.010999918 0.12099999 0.032999992 c 0.055000007 0.09899998 0.088 0.17599988 0.09899998 0.25300002 c 0.19800001 0.83599997 0.45100003 1.2539997 0.74799997 1.2539997 c 0.19800007 0 0.29700005 -0.1539998 0.29700005 -0.4619999 c 0 -0.14299989 -0.054999948 -0.43999982 -0.176 -0.8909998 l -0.627 -2.497 c -0.032999992 -0.143 -0.09900004 -0.42900002 -0.09900004 -0.48400003 c 0 -0.22 0.12099999 -0.32999998 0.36299998 -0.32999998 c 0.20899999 0 0.36300004 0.11 0.44000006 0.32999998 c 0.021999955 0.055000007 0.08799994 0.32999998 0.20899999 0.803 l 0.23100007 0.979 l 0.32999992 1.254 c 0.12100005 0.25300002 0.3080001 0.50600004 0.53900003 0.77 c 0.319 0.35200024 0.7149999 0.5279999 1.188 0.5279999 c 0.36299992 0 0.53900003 -0.24199963 0.53900003 -0.7149997 c 0 -0.41799998 -0.23099995 -1.2540002 -0.704 -2.5080001 c -0.07700014 -0.19799995 -0.11000013 -0.36299992 -0.11000013 -0.5059999 c 0 -0.53900003 0.40700006 -0.935 0.93499994 -0.935 c 0.4840002 0 0.86899996 0.275 1.144 0.825 c 0.20900011 0.44000006 0.31900024 0.737 0.31900024 0.88 c 0 0.09899998 -0.055000305 0.15400004 -0.17600012 0.15400004 c -0.032999992 0 -0.19799995 -0.0990001 -0.19799995 -0.23100007 Z "/></symbol></defs></svg></span> 个，可以保证效率。为了省空间这个数组可以每个节点 <code>new</code> 一个出来，代替等长的数组。</p>
        <h3>代码</h3>
        <p>代码实现十分繁琐。要处处记得取模。</p>
        <p>值域比较小的变量就不要开 <code>long long</code>，会 MLE。</p>
        <pre><code>#include &lt;bits/stdc++.h><br><br>using std::cin;<br>using std::cout;<br>using std::vector;<br><br>typedef long long ll;<br>typedef vector&lt;ll> V;<br>typedef vector&lt;ll>::iterator iter;<br><br>const int MOD = 1e9 + 7;<br>const ll MAX = 1e5 + 5;<br><br>ll n, m, l, r, op, x;<br>ll num[MAX], opr[MAX];<br><br>ll qp(ll a, ll x)<br>{<br>  ll res = 1;<br>  while (x)<br>  {<br>    if (x &amp; 1) { res = res * a % MOD; }<br>    a = a * a % MOD; x >>= 1;<br>  }<br>  return res % MOD;<br>}<br><br>struct T<br>{<br>  bool at, mt, op;<br>  int lv, rv;<br>  int * c; V v;<br>  ll ln, sq;<br>  ll sm, ml, lm, rm, lc, rc, vl, ag;<br>  void clear()<br>  {<br>    for (int i = 1; i &lt;= sq; ++i) { c[i] = 0; } v.clear();<br>  }<br><br>  void asgadd()<br>  {<br>    vl = sm % MOD; op = 0; lc = rc = 1; lm = lv, rm = rv;<br>    clear(); c[1] += ln;<br>    at = true; mt = false;<br>  }<br><br>  void asgmul()<br>  {<br>    vl = ml % MOD; op = 1; lc = rc = ln; lm = rm = ml % MOD;<br>    clear(); if (ln &lt;= sq) { ++c[ln]; } else { v.push_back(ln); }<br>    mt = true; at = false;<br>  }<br><br>  void asg(ll v)<br>  {<br>    v %= MOD; lv = rv = v; vl = 0;<br>    lm = qp(v, lc); rm = qp(v, rc); ml = qp(v, ln); sm = v * ln % MOD;<br>    ll now = v;<br>    for (int i = 1; i &lt;= sq; ++i, now = now * v % MOD)<br>    {<br>      if (c[i])<br>      {   <br>        vl = (vl + 1ll * now * c[i] % MOD) % MOD;<br>      }<br>    }<br>    for (int i : this -> v)<br>    {<br>      vl = (vl + qp(v, i)) % MOD; <br>    }<br>    ag = v;<br>  }<br><br>  void merge(T &amp; l, T &amp; r)<br>  {<br>    sm = (l.sm + r.sm) % MOD;<br>    ml = 1ll * l.ml * r.ml % MOD;<br>    lv = l.lv, rv = r.rv;<br>    op = r.op;<br>    lm = l.lm % MOD, rm = r.rm % MOD, lc = l.lc, rc = r.rc;<br>    if (l.op and l.lc == l.ln) { lc = l.ln + r.lc; lm = 1ll * l.ml * r.lm % MOD; }<br>    if (l.op and r.rc == r.ln) { rc = r.ln + l.rc; rm = 1ll * r.ml * l.rm % MOD; }<br>    vl = (l.vl + r.vl) % MOD;<br>    if (l.op)<br>    {<br>      vl = ((((l.vl + r.vl) % MOD + 1ll * l.rm * r.lm % MOD) % MOD - (l.rm + r.lm) % MOD) % MOD + MOD) % MOD;<br>    }<br>    clear();<br>    for (int i = 1; i &lt;= l.sq; ++i) { c[i] += l.c[i]; }<br>    for (int i = 1; i &lt;= r.sq; ++i) { c[i] += r.c[i]; }<br>    int i1 = 0, i2 = 0, e1 = l.v.size(), e2 = r.v.size();<br>    while (i1 &lt; e1 and i2 &lt; e2)<br>    {<br>      if (l.v[i1] &lt; r.v[i2])<br>      {<br>        if (l.v[i1] &lt;= sq) { c[l.v[i1]]++; }<br>        else { v.push_back(l.v[i1]); }<br>        ++i1;<br>      }<br>      else<br>      {<br>        if (r.v[i2] &lt;= sq) { c[r.v[i2]]++; }<br>        else { v.push_back(r.v[i2]); }<br>        ++i2;<br>      }<br>    }<br>    while (i1 &lt; e1)<br>    {<br>      if (l.v[i1] &lt;= sq) { c[l.v[i1]]++; }<br>      else { v.push_back(l.v[i1]); }<br>      ++i1;<br>    }<br>    while (i2 &lt; e2)<br>    {<br>      if (r.v[i2] &lt;= sq) { c[r.v[i2]]++; }<br>      else { v.push_back(r.v[i2]); }<br>      ++i2;<br>    }   <br>    if (l.op)<br>    {<br>      if (l.rc &lt;= sq) { --c[l.rc]; }<br>      else { iter i = lower_bound(v.begin(), v.end(), l.rc); v.erase(i); }<br>      if (r.lc &lt;= sq) { --c[r.lc]; }<br>      else { iter i = lower_bound(v.begin(), v.end(), r.lc); v.erase(i); }<br>      if (l.rc + r.lc &lt;= sq) { ++c[l.rc + r.lc]; }<br>      else { iter i = lower_bound(v.begin(), v.end(), l.rc + r.lc); v.insert(i, l.rc + r.lc); }<br>    }<br>  }<br>  <br>  void pushdown(T &amp; l, T &amp; r)<br>  {<br>    if (ag) { l.asg(ag); r.asg(ag); ag = 0; } <br>    if (at) { l.asgadd(); r.asgadd(); at = false; }<br>    if (mt) { l.asgmul(); r.asgmul(); mt = false; }<br>  }<br>} a[MAX &lt;&lt; 2 | 1];<br><br>struct A<br>{<br>  ll lm, rm, lc, rc, vl, ln, op;<br>};<br><br>A merge(A l, A r)<br>{<br>  A x;<br>  x.op = r.op; x.ln = l.ln + r.ln;<br>  x.lc = l.lc; x.rc = r.rc;<br>  x.lm = l.lm; x.rm = r.rm;<br>  if (l.op and l.lc == l.ln) { x.lc = l.ln + r.lc; x.lm = 1ll * l.lm * r.lm % MOD; }<br>  if (l.op and r.rc == r.ln) { x.rc = r.ln + l.rc; x.rm = 1ll * r.rm * l.rm % MOD; }<br>  x.vl = (l.vl + r.vl) % MOD;<br>  if (l.op)<br>  {<br>    x.vl = (((x.vl + 1ll * l.rm * r.lm) % MOD - (l.rm + r.lm) % MOD) % MOD + MOD) % MOD;<br>  }<br>  return x;<br>}<br><br>A query(int l, int r, int s, int t, int x)<br>{<br>  if (l >= s and r &lt;= t) { return {a[x].lm, a[x].rm, a[x].lc, a[x].rc, a[x].vl % MOD, a[x].ln, a[x].op}; }<br>  a[x].pushdown(a[x &lt;&lt; 1], a[x &lt;&lt; 1 | 1]);<br>  int k = l + ((r - l) >> 1);<br>  if (k >= t) { return query(l, k, s, t, x &lt;&lt; 1); }<br>  else if (k &lt;  s) { return query(k + 1, r, s, t, x &lt;&lt; 1 | 1); }<br>  else { return merge(query(l, k, s, t, x &lt;&lt; 1), query(k + 1, r, s, t, x &lt;&lt; 1 | 1)); }<br>}<br><br>void build(int l, int r, int x)<br>{<br>  a[x].ln = r - l + 1; a[x].sq = sqrt(a[x].ln); a[x].c = new int [a[x].sq + 3]();<br>  if (l == r)<br>  {<br>    a[x].vl = a[x].lv = a[x].rv = a[x].lm = a[x].rm = a[x].sm = a[x].ml = num[l];<br>    a[x].op = opr[l]; a[x].lc = a[x].rc = 1; a[x].c[1] = 1;<br>    return ;<br>  }<br>  int k = l + ((r - l) >> 1);<br>  build(l, k, x &lt;&lt; 1); build(k + 1, r, x &lt;&lt; 1 | 1);<br>  a[x].merge(a[x &lt;&lt; 1], a[x &lt;&lt; 1 | 1]);<br>}<br><br>void asg(int l, int r, int s, int t, ll v, int x)<br>{<br>  if (l >= s and r &lt;= t) { a[x].asg(v); return ; }<br>  a[x].pushdown(a[x &lt;&lt; 1], a[x &lt;&lt; 1 | 1]);<br>  int k = l + ((r - l) >> 1);<br>  if (k >= s) { asg(l, k, s, t, v, x &lt;&lt; 1); }<br>  if (k &lt;  t) { asg(k + 1, r, s, t, v, x &lt;&lt; 1 | 1); }<br>  a[x].merge(a[x &lt;&lt; 1], a[x &lt;&lt; 1 | 1]);<br>}<br><br>void asgadd(int l, int r, int s, int t, int x)<br>{<br>  if (l >= s and r &lt;= t) { a[x].asgadd(); return ; }<br>  a[x].pushdown(a[x &lt;&lt; 1], a[x &lt;&lt; 1 | 1]);<br>  int k = l + ((r - l) >> 1);<br>  if (k >= s) { asgadd(l, k, s, t, x &lt;&lt; 1); }<br>  if (k &lt;  t) { asgadd(k + 1, r, s, t, x &lt;&lt; 1 | 1); }<br>  a[x].merge(a[x &lt;&lt; 1], a[x &lt;&lt; 1 | 1]);<br>}<br><br>void asgmul(int l, int r, int s, int t, int x)<br>{<br>  if (l >= s and r &lt;= t) { a[x].asgmul(); return ; }<br>  a[x].pushdown(a[x &lt;&lt; 1], a[x &lt;&lt; 1 | 1]);<br>  int k = l + ((r - l) >> 1);<br>  if (k >= s) { asgmul(l, k, s, t, x &lt;&lt; 1); }<br>  if (k &lt;  t) { asgmul(k + 1, r, s, t, x &lt;&lt; 1 | 1); }<br>  a[x].merge(a[x &lt;&lt; 1], a[x &lt;&lt; 1 | 1]);<br>}<br><br><br>int main()<br>{<br>  cin.tie(NULL); cout.tie(NULL); std::ios::sync_with_stdio(false);<br>  cin >> n >> m;<br>  for (int i = 1; i &lt;= n; ++i) { cin >> num[i]; num[i] %= MOD; }<br>  for (int i = 1; i &lt;  n; ++i) { cin >> opr[i]; }<br>  build(1, n, 1);<br>  while (m--)<br>  {<br>    cin >> op >> l >> r;<br>    if (op != 3) { cin >> x; }<br>    if (op == 1) { asg(1, n, l, r, x % MOD, 1); }<br>    else if (op == 2)<br>    {<br>      if (x == 0) { asgadd(1, n, l, r, 1); }<br>      else { asgmul(1, n, l, r, 1); }<br>    }<br>    else { cout &lt;&lt; query(1, n, l, r, 1).vl % MOD &lt;&lt; '\n'; }<br>  }<br>}</code></pre>
      </section>
    </article>
  </body>
</html>
